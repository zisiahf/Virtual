<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>学生登录</title>
    <script src="../../../js/jquery/jquery.min.js"></script>
    <script src="../../../js/bootstrap/bootstrap.js"></script>
    <script src="../../../js/jquery/jquery.seat-charts.min.js"></script>
    <script src="../../../js/layer/layer.js"></script>
    <script src="../../../js/md5.min.js"></script>
    <script src="../../../js/common.js"></script>
    <link href="../../../css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="../../../css/style.css" rel="stylesheet">
    <link href="../../../css/login.css" rel="stylesheet">
</head>

<body>
<!-- 1、头部广告栏 -->
<div align="center">
    <div class="contest_nav banner_div">
        <a href="#"><img src="../../../images/banner.png" width="100%" height="116px"></a>
    </div>
    <div style="width:980px">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">物联网远程虚拟实验平台</a>
                </div>
            </div>
        </nav>
    </div>
</div>

<!-- 2、学生登录模块 -->
<div class="login">
    <div class="message">实验平台-学生登录</div>
    <form method="post" id="form">
        <input name="node_number" type="hidden" id="node_number">

        <hr class="hr30">
        <!--<label style="color:red;padding-left: 5px;height:20px" id="msg"></label>-->
        <input name="username" placeholder="请输入用户名" type="text" id="username">
        <hr class="hr15">
        <input name="password" placeholder="请输入密码" type="password" id="password">
        <hr class="hr15">
        <input value="登录" style="width:100%;" type="button" id="login">
        <!--<a onClick="alert('请联系管理员')">我的节点:</a>-->
    </form>
</div>


<!-- 3、node节点选择的模态弹框 Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">选择节点</h4>
            </div>
            <div class="modal-body">
                <div id="seat-map">
                    <div class="seatCharts-row">
                        <div id="1_1" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_1</div>
                        <div id="1_2" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_2</div>
                        <div id="1_3" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_3</div>
                        <div id="1_4" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_4</div>
                        <div id="1_5" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_5</div>
                        <div id="1_6" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_6</div>
                        <div id="1_7" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_7</div>
                        <div id="1_8" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_8</div>
                        <div id="1_9" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_9</div>
                        <div id="1_10" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">1_10</div>
                    </div>
                    <div class="seatCharts-row">
                        <div id="2_1" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell  unavailable">2_1</div>
                        <div id="2_2" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell  unavailable">2_2</div>
                        <div id="2_3" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell  unavailable">2_3</div>
                        <div id="2_4" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell  unavailable">2_4</div>
                        <div id="2_5" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_5</div>
                        <div id="2_6" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_6</div>
                        <div id="2_7" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_7</div>
                        <div id="2_8" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_8</div>
                        <div id="2_9" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_9</div>
                        <div id="2_10" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_10</div>
                    </div>
                    <div class="seatCharts-row">
                        <div id="3_1" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_1</div>
                        <div id="3_2" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_2</div>
                        <div id="3_3" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_3</div>
                        <div id="3_4" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_4</div>
                        <div id="3_5" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_5</div>
                        <div id="3_6" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_6</div>
                        <div id="3_7" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_7</div>
                        <div id="3_8" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_8</div>
                        <div id="3_9" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_9</div>
                        <div id="3_10" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">2_10</div>
                    </div>
                    <div class="seatCharts-row">
                    <div id="4_1" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_1</div>
                    <div id="4_2" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_2</div>
                    <div id="4_3" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_3</div>
                    <div id="4_4" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_4</div>
                    <div id="4_5" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_5</div>
                    <div id="4_6" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_6</div>
                    <div id="4_7" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_7</div>
                    <div id="4_8" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_8</div>
                    <div id="4_9" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_9</div>
                    <div id="4_10" role="checkbox" aria-checked="false" focusable="true" class="seatCharts-seat seatCharts-cell unavailable">4_10</div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="submit">提交</button>
            </div>
        </div>
    </div>
</div>


</body>
<script type="text/javascript">
    var curNodeCount = 0; //预约节点数量
    var chosedNodeCount = 4; //可选节点数量, 难道每个实验都只是且只能选择四个节点吗

    $(document).ready(function() {
        //初始化节点 查看可用节点数量
    });


    //后端查询当前可用节点
    $.findAvailableNode = function() {
        $.ajax({
            type: "get",
            url: "/node/findAvailableNode",
            dataType: 'json',
            success: function(res) {
                if(res.data != null){
                    $.each(res.data, function() {
                        $("#" + this.num).attr("class", "seatCharts-seat seatCharts-cell available");
                    });
                }
            },
            error: function() {}
        });
    }


    //查看本次节点数量
    $.getChosedNodeNumber = function() {
        //带上预约id
        $.ajax({
            type: "get",
            url: "/student/findAvailableNode",
            dataType: 'json',
            success: function(res) {
                chosedNodeCount = res.data.chosedNodeCount;
            },
            error: function() {}
        });
    }


    //提交数据
    $("#submit").click(function() {
        //处理中
        //设置隐藏input值
        if ($.checkForm()) {
            //获取选中的节点
            var node_number = "";
            $("div[aria-checked='true']").each(function() {
                node_number = node_number + this.getAttribute("id") + ",";
            });
            node_number = node_number.substring(0, node_number.length - 1);
            console.log(node_number);
            $("#node_number").attr("value", node_number);
            console.log(node_number);
            //md5加密  202cb962ac59075b964b07152d234b70
            var password = $("#password").val();
            password = md5(password);
            //提交数据 用户名 密码 节点编号到后端
            $.ajax({
                type: "post",
                url: "/student/doLogin",
                data: {
                    node_number: $("#node_number").val(),
                    username: $("#username").val(),
                    password: password,
                    oid: getQueryVariable("oid")
                    },
                success: function(res) {
                    console.log(res);
                    console.log(this.data);
                    if(res.code == 0){  /* data.code == 0 */
                        location.href = "/student/startEx?token="+res.data;
                    }else{
                        layer.msg(res.msg);
                        $.findAvailableNode();
                    }
                },
                error: function(res) {
                    layer.msg("系统错误");
                }
            });
        }
    });


    //登录校验
    $.checkForm = function() {
        //校验节点数量
        if (curNodeCount == 0) {
            layer.msg("请选择节点");
            return false;
        }
        if (curNodeCount != chosedNodeCount) {
            layer.msg("你可选的节点数量是" + chosedNodeCount + "个");
            return false;
        }
        //校验用户名和密码
        var $name = $("#username").val(); //用户名
        var $pwd = $("#password").val(); //密码
        if ($name == "" || $.trim($name) == "") {
            layer.msg("请输入用户名");
            return false;
        } else if ($pwd == "" || $.trim($pwd) == "") {
            layer.msg("请输入密码");
            return false;
        }
        return true;
    }


    //模态框选择节点
    $("div[role='checkbox']").click(function() {
        var classAttr = this.getAttribute("class");
        if (classAttr.indexOf("unavailable") != -1) {
            return;
            //添加数据
        } else if (classAttr.indexOf("selected") != -1) {
            this.setAttribute("class", "seatCharts-seat seatCharts-cell available");
            this.setAttribute("aria-checked", "false");
            curNodeCount--;
        }else if (classAttr.indexOf("available") != -1) {
            this.setAttribute("class", "seatCharts-seat seatCharts-cell selected");
            this.setAttribute("aria-checked", "true");
            curNodeCount++;
        }

    });


    //手动打开模态框
    $("#login").click(function() {
        $('#myModal').modal({
            keyboard: false,
            backdrop: false,
            show: true
        })
    });


    //模态框show方法调用时触发
    $('#myModal').on('show.bs.modal', function(e) {
        // do something...
        //查询后端节点使用情况
        $.findAvailableNode();
    })


</script>

</html>